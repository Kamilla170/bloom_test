from config import STATE_EMOJI, STATE_NAMES

def format_plant_analysis(raw_text: str, confidence: float = None, state_info: dict = None) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º"""
    lines = [line.strip() for line in raw_text.split('\n') if line.strip()]
    formatted = ""
    
    plant_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ"
    confidence_level = confidence or 0
    
    for line in lines:
        if line.startswith("–†–ê–°–¢–ï–ù–ò–ï:"):
            plant_name = line.replace("–†–ê–°–¢–ï–ù–ò–ï:", "").strip()
            display_name = plant_name.split("(")[0].strip()
            formatted += f"üåø <b>{display_name}</b>\n"
            if "(" in plant_name:
                latin_name = plant_name[plant_name.find("(")+1:plant_name.find(")")]
                formatted += f"üè∑Ô∏è <i>{latin_name}</i>\n"
            
        elif line.startswith("–£–í–ï–†–ï–ù–ù–û–°–¢–¨:"):
            conf = line.replace("–£–í–ï–†–ï–ù–ù–û–°–¢–¨:", "").strip()
            try:
                confidence_level = float(conf.replace("%", ""))
                if confidence_level >= 80:
                    conf_icon = "üéØ"
                elif confidence_level >= 60:
                    conf_icon = "üé™"
                else:
                    conf_icon = "ü§î"
                formatted += f"{conf_icon} <b>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</b> {conf}\n\n"
            except:
                formatted += f"üé™ <b>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</b> {conf}\n\n"
        
        elif line.startswith("–¢–ï–ö–£–©–ï–ï_–°–û–°–¢–û–Ø–ù–ò–ï:"):
            pass
        
        elif line.startswith("–°–û–°–¢–û–Ø–ù–ò–ï:"):
            condition = line.replace("–°–û–°–¢–û–Ø–ù–ò–ï:", "").strip()
            if any(word in condition.lower() for word in ["–∑–¥–æ—Ä–æ–≤", "—Ö–æ—Ä–æ—à", "–æ—Ç–ª–∏—á–Ω", "–Ω–æ—Ä–º"]):
                icon = "‚úÖ"
            elif any(word in condition.lower() for word in ["–ø—Ä–æ–±–ª–µ–º", "–±–æ–ª–µ–Ω", "–ø–ª–æ—Ö", "—Å—Ç—Ä–µ—Å—Å"]):
                icon = "‚ö†Ô∏è"
            else:
                icon = "‚ÑπÔ∏è"
            formatted += f"{icon} <b>–û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {condition}\n\n"
        
        elif line.startswith("–ü–û–õ–ò–í_–ê–ù–ê–õ–ò–ó:"):
            analysis = line.replace("–ü–û–õ–ò–í_–ê–ù–ê–õ–ò–ó:", "").strip()
            if "–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ" in analysis.lower() or "–Ω–µ –≤–∏–¥–Ω–∞" in analysis.lower():
                icon = "‚ùì"
            else:
                icon = "üíß"
            formatted += f"{icon} <b>–ê–Ω–∞–ª–∏–∑ –ø–æ–ª–∏–≤–∞:</b> {analysis}\n"
            
        elif line.startswith("–ü–û–õ–ò–í_–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"):
            recommendations = line.replace("–ü–û–õ–ò–í_–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:", "").strip()
            formatted += f"üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</b> {recommendations}\n"
            
        elif line.startswith("–ü–û–õ–ò–í_–ò–ù–¢–ï–†–í–ê–õ:"):
            interval = line.replace("–ü–û–õ–ò–í_–ò–ù–¢–ï–†–í–ê–õ:", "").strip()
            formatted += f"‚è∞ <b>–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–ª–∏–≤–∞:</b> –∫–∞–∂–¥—ã–µ {interval} –¥–Ω–µ–π\n\n"
            
        elif line.startswith("–°–í–ï–¢:"):
            light = line.replace("–°–í–ï–¢:", "").strip()
            formatted += f"‚òÄÔ∏è <b>–û—Å–≤–µ—â–µ–Ω–∏–µ:</b> {light}\n"
            
        elif line.startswith("–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê:"):
            temp = line.replace("–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê:", "").strip()
            formatted += f"üå°Ô∏è <b>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</b> {temp}\n"
            
        elif line.startswith("–í–õ–ê–ñ–ù–û–°–¢–¨:"):
            humidity = line.replace("–í–õ–ê–ñ–ù–û–°–¢–¨:", "").strip()
            formatted += f"üí® <b>–í–ª–∞–∂–Ω–æ—Å—Ç—å:</b> {humidity}\n"
            
        elif line.startswith("–ü–û–î–ö–û–†–ú–ö–ê:"):
            feeding = line.replace("–ü–û–î–ö–û–†–ú–ö–ê:", "").strip()
            formatted += f"üçΩÔ∏è <b>–ü–æ–¥–∫–æ—Ä–º–∫–∞:</b> {feeding}\n"
        
        elif line.startswith("–°–û–í–ï–¢:"):
            advice = line.replace("–°–û–í–ï–¢:", "").strip()
            formatted += f"\nüí° <b>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å–æ–≤–µ—Ç:</b> {advice}"
        
        elif line.startswith("–°–ï–ó–û–ù–ù–´–ô_–°–û–í–ï–¢:"):
            seasonal_advice = line.replace("–°–ï–ó–û–ù–ù–´–ô_–°–û–í–ï–¢:", "").strip()
            formatted += f"\n\nüåç <b>–í–∞–∂–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∑–æ–Ω–∞:</b> {seasonal_advice}"
    
    if state_info:
        current_state = state_info.get('current_state', 'healthy')
        state_emoji = STATE_EMOJI.get(current_state, 'üå±')
        state_name = STATE_NAMES.get(current_state, '–ó–¥–æ—Ä–æ–≤–æ–µ')
        
        formatted = f"\n{state_emoji} <b>–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:</b> {state_name}\n" + formatted
        
        if state_info.get('state_reason'):
            formatted += f"\nüìã <b>–ü–æ—á–µ–º—É:</b> {state_info['state_reason']}"
    
    if confidence_level >= 80:
        formatted += "\n\nüèÜ <i>–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</i>"
    elif confidence_level >= 60:
        formatted += "\n\nüëç <i>–•–æ—Ä–æ—à–µ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</i>"
    else:
        formatted += "\n\nü§î <i>–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</i>"
    
    formatted += "\nüíæ <i>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π!</i>"
    
    return formatted


def get_state_recommendations(state: str, plant_name: str = "—Ä–∞—Å—Ç–µ–Ω–∏–µ") -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è"""
    recommendations = {
        'flowering': f"""
üíê <b>{plant_name} —Ü–≤–µ—Ç–µ—Ç!</b>

<b>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —É—Ö–æ–¥–µ:</b>
‚Ä¢ üíß <b>–ü–æ–ª–∏–≤:</b> –ß–∞—â–µ –Ω–∞ 2 –¥–Ω—è (–±–æ–ª—å—à–µ –≤–æ–¥—ã –ø—Ä–∏ —Ü–≤–µ—Ç–µ–Ω–∏–∏)
‚Ä¢ üçΩÔ∏è <b>–ü–æ–¥–∫–æ—Ä–º–∫–∞:</b> –£–¥–æ–±—Ä–µ–Ω–∏–µ –¥–ª—è —Ü–≤–µ—Ç–µ–Ω–∏—è 1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
‚Ä¢ ‚òÄÔ∏è <b>–°–≤–µ—Ç:</b> –ë–æ–ª—å—à–µ —Å–≤–µ—Ç–∞, –Ω–æ –∏–∑–±–µ–≥–∞–π—Ç–µ –ø—Ä—è–º—ã—Ö –ª—É—á–µ–π
‚Ä¢ üå°Ô∏è <b>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</b> –°—Ç–∞–±–∏–ª—å–Ω–∞—è, –±–µ–∑ –ø–µ—Ä–µ–ø–∞–¥–æ–≤

‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> –ù–µ –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è —Ü–≤–µ—Ç–µ–Ω–∏—è!
üí° <b>–°–æ–≤–µ—Ç:</b> –£–¥–∞–ª—è–π—Ç–µ —É–≤—è–¥—à–∏–µ —Ü–≤–µ—Ç—ã –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–µ–Ω–∏—è
""",
        'active_growth': f"""
üåø <b>{plant_name} –∞–∫—Ç–∏–≤–Ω–æ —Ä–∞—Å—Ç–µ—Ç!</b>

<b>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —É—Ö–æ–¥–µ:</b>
‚Ä¢ üíß <b>–ü–æ–ª–∏–≤:</b> –†–µ–≥—É–ª—è—Ä–Ω—ã–π, –Ω–µ –¥–æ–ø—É—Å–∫–∞–π—Ç–µ –ø–µ—Ä–µ—Å—ã—Ö–∞–Ω–∏—è
‚Ä¢ üçΩÔ∏è <b>–ü–æ–¥–∫–æ—Ä–º–∫–∞:</b> –ö–∞–∂–¥—ã–µ 2 –Ω–µ–¥–µ–ª–∏ —É–¥–æ–±—Ä–µ–Ω–∏–µ–º –¥–ª—è —Ä–æ—Å—Ç–∞
‚Ä¢ ‚òÄÔ∏è <b>–°–≤–µ—Ç:</b> –ú–∞–∫—Å–∏–º—É–º —Å–≤–µ—Ç–∞ –¥–ª—è —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑–∞
‚Ä¢ ü™¥ <b>–ü–µ—Ä–µ—Å–∞–¥–∫–∞:</b> –ï—Å–ª–∏ –∫–æ—Ä–Ω—è–º —Ç–µ—Å–Ω–æ - –ø–µ—Ä–µ—Å–∞–¥–∏—Ç–µ

üí° <b>–°–æ–≤–µ—Ç:</b> –≠—Ç–æ –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫—Ä–æ–Ω—ã
""",
        'dormancy': f"""
üò¥ <b>{plant_name} –≤ –ø–µ—Ä–∏–æ–¥–µ –ø–æ–∫–æ—è</b>

<b>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —É—Ö–æ–¥–µ:</b>
‚Ä¢ üíß <b>–ü–æ–ª–∏–≤:</b> –†–µ–∂–µ –Ω–∞ 5 –¥–Ω–µ–π (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ–ª–∏–≤)
‚Ä¢ üçΩÔ∏è <b>–ü–æ–¥–∫–æ—Ä–º–∫–∞:</b> –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –¥–æ –≤–µ—Å–Ω—ã
‚Ä¢ üå°Ô∏è <b>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</b> –ü—Ä–æ—Ö–ª–∞–¥–Ω–µ–µ 15-18¬∞C
‚Ä¢ ‚òÄÔ∏è <b>–°–≤–µ—Ç:</b> –ú–µ–Ω—å—à–µ —Å–≤–µ—Ç–∞ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ

üí° <b>–°–æ–≤–µ—Ç:</b> –í–µ—Å–Ω–æ–π —Ä–∞—Å—Ç–µ–Ω–∏–µ –ø—Ä–æ—Å–Ω–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º–∏ —Å–∏–ª–∞–º–∏!
‚ö†Ô∏è –ù–µ —Ç—Ä–µ–≤–æ–∂—å—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥
""",
        'stress': f"""
‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ! {plant_name} –≤ —Å—Ç—Ä–µ—Å—Å–µ</b>

<b>–°—Ä–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</b>
‚Ä¢ üîç <b>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:</b> –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (–ø–æ–ª–∏–≤/—Å–≤–µ—Ç/–≤—Ä–µ–¥–∏—Ç–µ–ª–∏)
‚Ä¢ üíß <b>–ü–æ–ª–∏–≤:</b> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–ª–∞–∂–Ω–æ—Å—Ç—å - –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ —Ä–µ–∂–∏–º
‚Ä¢ ‚úÇÔ∏è <b>–û–±—Ä–µ–∑–∫–∞:</b> –£–¥–∞–ª–∏—Ç–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ –ª–∏—Å—Ç—å—è
‚Ä¢ ü¶† <b>–í—Ä–µ–¥–∏—Ç–µ–ª–∏:</b> –û—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–∏—Å—Ç—å—è —Å –¥–≤—É—Ö —Å—Ç–æ—Ä–æ–Ω
‚Ä¢ üí® <b>–ü—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞–Ω–∏–µ:</b> –£–ª—É—á—à–∏—Ç–µ —Ü–∏—Ä–∫—É–ª—è—Ü–∏—é –≤–æ–∑–¥—É—Ö–∞

üì∏ <b>–í–∞–∂–Ω–æ:</b> –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ 3-5 –¥–Ω–µ–π –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è!
‚ùì –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç - –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å —Å —Ñ–æ—Ç–æ –ø—Ä–æ–±–ª–µ–º—ã
""",
        'adaptation': f"""
üîÑ <b>{plant_name} –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è</b>

<b>–©–∞–¥—è—â–∏–π —Ä–µ–∂–∏–º:</b>
‚Ä¢ üíß <b>–ü–æ–ª–∏–≤:</b> –£–º–µ—Ä–µ–Ω–Ω—ã–π, –±–µ–∑ –ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏—è
‚Ä¢ ‚òÄÔ∏è <b>–°–≤–µ—Ç:</b> –ù–µ —Å—Ç–∞–≤—å—Ç–µ –Ω–∞ —è—Ä–∫–æ–µ —Å–æ–ª–Ω—Ü–µ —Å—Ä–∞–∑—É
‚Ä¢ üå°Ô∏è <b>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</b> –°—Ç–∞–±–∏–ª—å–Ω–∞—è, –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞
‚Ä¢ ‚è∞ <b>–í—Ä–µ–º—è:</b> –î–∞–π—Ç–µ 2-3 –Ω–µ–¥–µ–ª–∏ –Ω–∞ –ø—Ä–∏–≤—ã–∫–∞–Ω–∏–µ

üí° <b>–°–æ–≤–µ—Ç:</b> –ù–µ –ø–µ—Ä–µ—Å–∞–∂–∏–≤–∞–π—Ç–µ –∏ –Ω–µ —Ç—Ä–µ–≤–æ–∂—å—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ
üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
""",
        'healthy': f"""
üå± <b>{plant_name} –∑–¥–æ—Ä–æ–≤–æ–µ!</b>

<b>–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–π —É—Ö–æ–¥:</b>
‚Ä¢ üíß –†–µ–≥—É–ª—è—Ä–Ω—ã–π –ø–æ–ª–∏–≤ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É
‚Ä¢ üçΩÔ∏è –ü–æ–¥–∫–æ—Ä–º–∫–∞ –ø–æ —Å–µ–∑–æ–Ω—É
‚Ä¢ ‚òÄÔ∏è –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–µ—Ç–∞
‚Ä¢ üå°Ô∏è –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞

üí° <b>–°–æ–≤–µ—Ç:</b> –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!
üì∏ –û–±–Ω–æ–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
"""
    }
    
    return recommendations.get(state, recommendations['healthy'])
